---
title: "Survival analysis week 2"
author: "Petteri Mäntymaa"
date: "March 20, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse);library(survival); library(eha);library(ggplot2);library(tinytex)
data(veteran)
```

## Exercise 2: Paramteric survival models and model checking

### 1. Properties of exponential distribution
#### 1.1. 

Let $T_{1},\dots, T_{n}$ be a random sample from a distribution with survival function $S(t) = exp\{−\lambda t\}$. Show that the distribution of $T = nmin(T1,\dots, Tn)$ is exponential with failure rate $\lambda$.

Note: you may prove that this result (in limit) holds even when $S(t)$ is such that $S(t) = 1 − \lambda t + o(t)$ as $t \rightarrow 0$ where $o(t)$ means $\frac{o(t)}{t} \rightarrow 0$ as $t \rightarrow 0$.

#### 1.2.

Show that the exponential distribution is the only continuous distribution for which the mean residual lifetime $r(t)$ is constant for all $t > 0$.

#### 1.3.

Show that the nth moment of the exponential distribution with falire rate $\lambda$ is $E(T^n) = \frac{n!}{\lambda n}$.

We have the density function $f(t)=\lambda e^{-\lambda t}$ where $t>0$.

Thus as the moment generating function we have

$$
\begin{aligned}
M_t(z) = E(e^{zt}) &= \int_0^\infty e^{zt} \lambda e^{-\lambda t} dt \\
                   &= \int_0^\infty e^{(z-\lambda)t} dt \\
                   &= \frac{\lambda}{z-\lambda}\Big/_0^\infty e^{(z-\lambda)t} \\
                   &= \frac{\lambda}{z-\lambda}\lim_{t \to \infty} \big(e^{(z-\lambda)t} - e^{(z-\lambda)0} \big) \\
                   &= \frac{\lambda}{z-\lambda} (0-1) \\
                   &= \frac{\lambda}{\lambda-z}
\end{aligned}
$$

WRITE GEOM SERIES HERE

#### 2. Fitting exponential and Weibull model to Veteran data

Load veteran data from library(survival).

#### 2.1.

Plot a histogram of the survival times corresponding to uncensored observations `(veteran$status == 1)` as done in Exercise 1.

```{r}
veteran %>%
  ggplot() +
  aes(x = time, fill = factor(status)) +
  geom_histogram(binwidth = 40, color = "black") +
  theme_minimal() +
  labs(title = "Survival time of individuals", subtitle = "Veterans' Administration Lung Cancer study") +
  xlab("Survival time (days)") +
  ylab("Frequency")
```

> Minor addition to last weeks histogram; The colour indicates censoring status, red for censored (survival time unknown) and blue for non-censored (survival time known, i.e. event occurs in the study period).

#### 2.2.

Compare the Kaplan-Meier estimate of the survival function to (a) Exponential distribution, and (b) Weibull distribution. Use graphical procedure and interpret the results.

Hint: You can obtain the maximum likelihood estimates of the parameters using `weibreg()` function of `eha` package. For example, the estimate of the parameter $\lambda$ in $S(t) = exp\{−\lambda t\}$ is obtained using 

> Vertaa jakaumia kuvassa, 

```{r}
veteran.exp0 <- weibreg(formula = Surv(time, status) ~ 1, data=veteran, shape=1)
lambda0 <- exp(-veteran.exp0$coeff[1])

plot(veteran.exp0)
```


The parameters of a Weibull distribution $S(t) = exp\{−(\frac{t}{b})^a\}$ are estimated by
```{r}
veteran.weibull0 <- weibreg(formula = Surv(time, status) ~ 1, data=veteran)
b <- exp(veteran.weibull0$coeff[1])
a <- exp(veteran.weibull0$coeff[2])
```

#### Model choice
#### 2.3.

Compare the above two models with the likelihood ratio test. Interpret the result. Hint: You can extract the log-likelihood values from the output objects of function weibreg. Use the pchisq function to calculate the p-value (tail probability). Alternative: You can calculate the likelihood ratio by using the anova command on the output objects from the two regression models using survreg.

#### 3. Simulation
#### 3.1.

Generate 100 random numbers from exponential distribution with mean 0.01 and store it in T. Before you do this, look at the help(rexp) and the parameter which it accepts.

#### 3.1.1.

Plot the empirical distribution function.

#### 3.1.2.

Esimate the rate (stored under obsrate) from the simulated data and overlay the plot of the distribution function 1 − exp(−obsrate ∗ t).

#### 3.1.3.

Overlay the plot of the true exponential distribution function.

#### 3.1.4.

Explore the possibilities for different kinds of line and point plots. Vary the plot symbol, line type, line width, and colour. Also, try to give legend in the above graph.


